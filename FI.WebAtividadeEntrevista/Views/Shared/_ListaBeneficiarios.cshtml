@model FI.WebAtividadeEntrevista.Models.BeneficiarioModal

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<div class="modal fade" id="modalBeneficiarios" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gerenciar Beneficiários</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Formulário para adicionar novo beneficiário -->
                <div class="row mb-3 align-items-end">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="font-weight-bold">CPF</label>
                            <input type="text" class="form-control cpf" id="CpfBeneficiario" placeholder="Ex.: 010.011.111-00">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="font-weight-bold">Nome</label>
                            <input type="text" class="form-control" id="NomeBeneficiario" placeholder="Ex.: Maria">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <label class="d-block invisible">Incluir</label>
                            <button type="button" class="btn btn-success btn-block py-2" id="btnIncluirBeneficiario">
                                Incluir
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabela de beneficiários (DENTRO DA MODAL) -->
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="tabelaBeneficiarios">
                        <thead class="thead-light">
                            <tr>
                                <th>CPF</th>
                                <th>Nome</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Beneficiários serão renderizados aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarBeneficiarios">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        // Array para armazenar os beneficiários
        var beneficiarios = [];

        // Máscara para CPF
        $('.cpf').mask('000.000.000-00', { reverse: true });

        // Função para formatar CPF para exibição
        function formatarCPF(cpf) {
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }

        // Função para renderizar a tabela
        function renderizarTabela() {
            var tbody = $('#tabelaBeneficiarios tbody');
            tbody.empty();

            beneficiarios.forEach(function (beneficiario, index) {
                var row = $('<tr>').attr('data-index', index);
                row.append($('<td>').text(formatarCPF(beneficiario.cpf)));
                row.append($('<td>').text(beneficiario.nome));

                var btnEditar = $('<button>')
                    .addClass('btn btn-primary btn-sm me-2') 
                    .html('<i class="fas fa-edit"></i> Editar')
                    .click(function () {
                        editarBeneficiario(index);
                    });


                var btnRemover = $('<button>')
                    .addClass('btn btn-primary btn-sm ')
                    .html('<i class="fas fa-trash"></i> Excluir')
                    .click(function () {
                        beneficiarios.splice(index, 1);
                        renderizarTabela();
                        atualizarCampoHidden();
                    });

                var cellAcoes = $('<td>');


                btnEditar.css('margin-right', '10px');
                cellAcoes.append(btnEditar, btnRemover);
                row.append(cellAcoes);
                tbody.append(row);
            });
        }

        // Função para atualizar o campo hidden no form principal
        function atualizarCampoHidden(beneficiarios) {
            $('#BeneficiariosJson').val(JSON.stringify(beneficiarios));

        }

        // Adicionar beneficiário
        $('#btnIncluirBeneficiario').click(function () {
            var cpf = $('#CpfBeneficiario').val().replace(/\D/g, '');
            var nome = $('#NomeBeneficiario').val().trim();

            if (!isValidCPF(cpf)) {
                alert('CPF inválido');
                return;
            }

            if (!nome) {
                alert('Informe o nome do beneficiário');
                return;
            }

            // Verificar se CPF já existe
            var existe = beneficiarios.some(function (b) {
                return b.cpf === cpf;
            });

            if (existe) {
                alert('Este CPF já foi adicionado');
                return;
            }

            // Adicionar ao array
            beneficiarios.push({
                cpf: cpf,
                nome: nome,
                clienteId: $('#ClienteId').val() || 0
            });

            console.log(beneficiarios);
            atualizarCampoHidden(beneficiarios);
            // Atualizar UI
            renderizarTabela();
            

            // Limpar campos
            $('#CpfBeneficiario, #NomeBeneficiario').val('');
            $('#CpfBeneficiario').focus();
        });

         /*Confirmar e fechar modal*/
        $('#btnConfirmarBeneficiarios').click(function () {
            $('#modalBeneficiarios').modal('hide');
        });

        // Sua função de validação de CPF (mantida como está)
        function isValidCPF(value) {
            if (!value) return false;

            let cpf = value.toString().replace(/[^\d]/g, '');

            if (cpf.length !== 11) return false;

            const invalids = [
                "00000000000", "11111111111", "22222222222", "33333333333",
                "44444444444", "55555555555", "66666666666", "77777777777",
                "88888888888", "99999999999"
            ];

            if (invalids.includes(cpf)) return false;

            for (let t = 9; t < 11; t++) {
                let sum = 0;

                for (let i = 0; i < t; i++) {
                    sum += parseInt(cpf[i]) * (t + 1 - i);
                }

                let digit = (sum * 10) % 11;
                if (digit === 10) digit = 0;

                if (parseInt(cpf[t]) !== digit) return false;
            }

            return true;
        }
    });


</script>